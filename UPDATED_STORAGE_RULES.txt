rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the file
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if user is expert or admin
    // This checks custom claims - you'll need to set these on users
    function isExpertOrAdmin() {
      return isAuthenticated() &&
             (request.auth.token.role == 'expert' ||
              request.auth.token.role == 'admin');
    }

    // Helper function to check if file size is within limit (4 MB)
    function isValidSize() {
      return request.resource.size <= 4 * 1024 * 1024;  // 4 MB limit
    }

    // Helper function to check if file is a valid document type
    function isValidFileType() {
      return request.resource.contentType.matches('image/.*') ||
             request.resource.contentType == 'application/pdf';
    }

    // Profile images: profile_images/{fileName}
    match /profile_images/{fileName} {
      allow read: if isAuthenticated();

      allow write: if isAuthenticated() &&
                     isValidSize() &&
                     request.resource.contentType.matches('image/.*');
    }

    // Tax documents: documents/{userId}/{document}
    match /documents/{userId}/{document} {
      // Allow read if:
      // - User owns the folder OR
      // - User is an expert/admin (can view all customer documents)
      allow read: if isAuthenticated() &&
                    (isOwner(userId) || isExpertOrAdmin());

      // Allow write if:
      // - Owner of the folder OR
      // - Expert/admin uploading on behalf of customer
      allow write: if isAuthenticated() &&
                     (isOwner(userId) || isExpertOrAdmin()) &&
                     isValidSize() &&
                     isValidFileType();

      // Allow delete if owner or expert/admin
      allow delete: if isAuthenticated() &&
                      (isOwner(userId) || isExpertOrAdmin());
    }

    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
